<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>購買節能電器退還減徵貨物稅補件通知信</title>
    <style>
        /* =========================================
           公務系統風格樣式表 (System Style v3.4)
           修改歷程：
           1. 優化錯誤檢核體驗：改為「離開欄位(Blur)」時才觸發警示
           2. 輸入過程中(Input)不顯示紅字，僅自動帶入正確日期
           3. 新增複製前的強制防呆檢核 (Validation Check)
           4. 內文自動帶入申請類別
           ========================================= */
        :root {
            --sys-bg: #dff0d8;          
            --sys-header-bg: linear-gradient(to bottom, #2b7bc4, #1e578c); 
            --sys-yellow: #fff9c4;      
            --sys-input-yellow: #ffffcc; 
            --sys-border: #8096ab;      
            --sys-text: #333333;
            --sys-error: #d32f2f;       
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: "PMingLiU", "新細明體", "Microsoft JhengHei", sans-serif;
            background-color: var(--sys-bg); 
            color: var(--sys-text);
            line-height: 1.4;
            padding: 10px;
            font-size: 16px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: var(--sys-bg);
            border: 1px solid var(--sys-border);
            padding: 4px;
        }

        .header {
            background: var(--sys-header-bg);
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            color: white;
            border: 1px solid #103a63;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.3);
            margin-bottom: 5px;
        }

        .title {
            font-size: 1.4rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            margin: 0;
            letter-spacing: 1px;
            text-align: left;
        }

        .info-bar {
            background-color: var(--sys-yellow);
            border: 1px solid #e0c240;
            padding: 6px 15px;
            font-size: 0.95rem;
            color: #b91c1c;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .info-bar::before {
            content: "!";
            display: inline-block;
            width: 18px;
            height: 18px;
            background: #b91c1c;
            color: white;
            text-align: center;
            line-height: 18px;
            border-radius: 50%;
            margin-right: 8px;
            font-size: 12px;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        @media (min-width: 1024px) {
            .grid-layout { grid-template-columns: 4fr 6fr; }
        }

        .card {
            background: white;
            border: 1px solid var(--sys-border);
            margin-bottom: 8px;
        }

        .card-header {
            background: linear-gradient(to bottom, #f0f8ff, #dceefc);
            padding: 8px 10px;
            font-weight: bold;
            color: #003366;
            border-bottom: 1px solid #a0bcd6;
            display: flex;
            align-items: center;
            font-size: 1.1rem;
        }

        .step-badge {
            background: #2b7bc4;
            color: white;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
            border-radius: 3px;
            margin-right: 10px;
            font-size: 0.9rem;
        }

        .card-body {
            padding: 12px;
            background-color: #fcfdfc;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .form-group label {
            display: block;
            font-size: 1rem;
            color: #000;
            margin-bottom: 3px;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 5px;
            border: 1px solid #767676;
            border-radius: 0;
            background-color: white;
            font-family: "PMingLiU", sans-serif;
            font-size: 1.05rem;
        }
        
        .form-control.input-key {
            background-color: var(--sys-input-yellow) !important;
        }

        .form-control:focus {
            outline: 2px solid #ffa500;
            background-color: #ffffff !important;
        }

        /* 錯誤狀態樣式 */
        .form-control.is-invalid {
            border: 2px solid var(--sys-error) !important;
            background-color: #ffebee !important;
            color: var(--sys-error);
        }
        
        .error-message {
            color: var(--sys-error);
            font-size: 0.9rem;
            font-weight: bold;
            margin-top: 4px;
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .error-message.show { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .checkbox-group {
            margin-bottom: 12px;
            border: 1px solid #ddd;
            padding: 0;
            background: white;
        }

        .section-title {
            font-weight: bold;
            color: #000;
            padding: 6px 10px;
            background-color: #e8e8e8;
            border-bottom: 1px solid #ccc;
            font-size: 1.05rem;
        }

        .checkbox-item {
            display: block;
            position: relative;
            cursor: pointer;
            padding: 4px 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .checkbox-item:last-child { border-bottom: none; }
        .checkbox-item:hover { background-color: #fff9c4; }

        .checkbox-item input[type="checkbox"] {
            margin-right: 6px;
            vertical-align: middle;
            width: 15px;
            height: 15px;
        }

        .checkbox-item span { vertical-align: middle; }
        
        .checkbox-item input:checked ~ span {
            color: #0000ff;
            font-weight: bold;
        }

        .other-input {
            width: 95%;
            margin-left: 20px;
            margin-top: 4px;
            padding: 4px;
            font-size: 1rem;
            border: 1px solid #999;
            background-color: var(--sys-input-yellow);
            display: none;
        }
        .other-input.show { display: block; }

        .right-col {
            position: sticky;
            top: 10px;
            height: calc(100vh - 80px);
        }

        .preview-header {
            background-color: #eee;
            padding: 6px 10px;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-title {
            color: #000;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .actions { display: flex; gap: 5px; }

        .btn {
            padding: 4px 15px;
            border: 1px solid #666;
            background: linear-gradient(to bottom, #fff, #e0e0e0);
            color: black;
            font-size: 0.95rem;
            cursor: pointer;
            border-radius: 2px;
        }
        .btn:hover {
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
            border-color: #333;
        }
        .btn:active { background: #ccc; }

        .webmail-bar {
            background-color: #fffbf0;
            border: 1px solid #e0c240;
            padding: 6px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .webmail-label {
            font-size: 0.9rem;
            font-weight: bold;
            color: #b96b00;
        }

        .btn-small {
            border: 1px solid #b96b00;
            background: #fff;
            color: #b96b00;
            padding: 2px 10px;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 2px;
            font-weight: bold;
        }
        .btn-small:hover { background-color: #fff4db; }

        .preview-area {
            border: 1px solid #999;
            background: white;
            padding: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        textarea#result-text {
            width: 100%;
            flex-grow: 1;
            padding: 15px;
            border: none;
            resize: none;
            font-family: "Courier New", Courier, monospace;
            font-size: 1.2rem;
            line-height: 1.6;
            color: #000;
            background: transparent;
        }
        textarea#result-text:focus { outline: none; }

        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #ffffcc;
            color: black;
            border: 2px solid #b96b00;
            padding: 10px 20px;
            font-weight: bold;
            box-shadow: 3px 3px 5px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }
        #toast.show { display: block; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1 class="title">購買節能電器退還減徵貨物稅補件通知信(離線單機版)</h1>
        </div>
        
        <div class="info-bar">
            系統提示：請確認資料正確後再複製通知內容。
        </div>

        <div class="grid-layout">
            
            <div class="left-col">
                
                <div class="card">
                    <div class="card-header">
                        <span class="step-badge">1</span>
                        基本資料輸入
                    </div>
                    <div class="card-body">
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label>收件編號 (自動帶入日期)</label>
                                <input type="text" id="caseNumber" 
                                       oninput="handleInput()" 
                                       onblur="validateCaseNumber()" 
                                       class="form-control input-key" 
                                       placeholder="請輸入14碼或17碼">
                                <div id="caseNumber-error" class="error-message">⚠️ 格式錯誤：請輸入 14 碼或 17 碼</div>
                            </div>
                            <div class="form-group">
                                <label>申請人姓名 (必填)</label>
                                <input type="text" id="applicantName" oninput="generateText()" class="form-control input-key" placeholder="">
                            </div>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label>申請類別</label>
                                <select id="applicationType" onchange="generateText()" class="form-control">
                                    <option value="電冰箱">電冰箱</option>
                                    <option value="冷暖氣機">冷暖氣機</option>
                                    <option value="除濕機">除濕機</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>申請人信箱 (必填)</label>
                                <input type="email" id="applicantEmail" oninput="generateText()" class="form-control input-key" placeholder="">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="step-badge">2</span>
                        缺件項目勾選
                    </div>
                    <div class="card-body" id="checklist-container">
                        </div>
                </div>
            </div>

            <div class="right-col">
                <div class="card" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="preview-header">
                        <div class="preview-title">
                            通知內容預覽
                        </div>
                        <div class="actions">
                            <button onclick="copyToClipboard()" class="btn">
                                複製全部內容
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 5px; background: #fffbf0; border-bottom:1px solid #e0c240;">
                        <div class="webmail-bar" style="margin-top:0; border:none; padding:0;">
                            <span class="webmail-label">WebMail 分項複製：</span>
                            <button onclick="copySpecific('email')" class="btn-small">1.信箱</button>
                            <button onclick="copySpecific('subject')" class="btn-small">2.主旨</button>
                            <button onclick="copySpecific('body')" class="btn-small">3.內文</button>
                        </div>
                    </div>

                    <div class="preview-area">
                        <textarea id="result-text" placeholder="系統將於此處產生信件內容..."></textarea>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="toast">
        <span id="toast-message">已複製到剪貼簿！</span>
    </div>

    <script>
        const OFFICER_INFO = {
            unitName: "財政部高雄國稅局苓雅稽徵所",
            officerName: "洪先生",
            officerPhone: "(07)3302058 分機6325",
            faxNumber: "（07）330-2139", 
            email: "NE50098@ntbk.gov.tw"
        };
        
        const data = [
            {
                id: 'identity',
                title: '國民身分證、護照或居留證影本',
                items: [
                    { id: '1-1', text: '未附國民身分證、護照或居留證影本。' },
                    { id: '1-2', text: '上傳證件模糊不清(請提供清晰可辨識之影本或照片)。' }
                ]
            },
            {
                id: 'invoice',
                title: '銷售人開立之統一發票或收據影本',
                items: [
                    { id: '2-1', text: '未附統一發票或收據。' },
                    { id: '2-2', text: '統一發票或收據所載品項與所申請品項不符。' },
                    { id: '2-3', text: '統一發票未載明購買品項(請提供出貨單或消費明細)。' }
                ]
            },
            {
                id: 'warranty',
                title: '申請電器之保證書或保固卡影本',
                items: [
                    { id: '3-1', text: '未附保證書或保固卡。' },
                    { id: '3-2', text: '所附保證書或保固卡模糊不清(請提供清晰可辨識之影本或照片)。' },
                    { id: '3-3', text: '保固書尚未填載產品型號及機器號碼(請提供機身照片)。' },
                    { id: '3-4', text: '所提供之冷暖氣機保固書為室內機型號及機器號碼(請提供室外機保固書或機身照片)。' }
                ]
            },
            {
                id: 'passbook',
                title: '申請人退稅帳戶存摺影本',
                items: [
                    { id: '4-1', text: '未附申請人退稅帳戶存摺影本。' },
                    { id: '4-2', text: '所附退稅帳戶存摺戶名與申請人不同。' },
                    { id: '4-3', text: '退稅帳戶存摺為優惠存摺(請提供一般活期存款帳戶)。' }
                ]
            },
            {
                id: 'high_risk',
                title: '高風險案件類型 (請提供說明電器產品置放地點及用途，並註明非供銷售使用)',
                items: [
                    { id: '5-1', text: '同一申請人，申請同一類別電器累計10臺以上。' },
                    { id: '5-2', text: '申請人非自然人，為高風險行業營業人。' },
                    { id: '5-3', text: '申請人為自然人，且為商家負責人或其配偶。' },
                    { id: '5-4', text: '申請人為自然人，且本人或配偶為高風險行業營業人之負責人。' }
                ]
            }
        ];

        const CHINESE_NUMS = ['一', '二', '三', '四', '五', '六', '七', '八', '九', '十'];
        let globalEmail = "";
        let globalSubject = "";
        let globalBody = "";

        function renderChecklist() {
            const container = document.getElementById('checklist-container');
            container.innerHTML = ''; 

            data.forEach((category, index) => {
                const section = document.createElement('div');
                section.className = 'checkbox-group';
                
                const title = document.createElement('h3');
                title.className = 'section-title';
                title.textContent = `${CHINESE_NUMS[index]}、${category.title}`;
                section.appendChild(title);

                const itemsContainer = document.createElement('div');

                category.items.forEach(item => {
                    const label = createCheckboxItem(item.text, category.title, false, null, category.id, item.id);
                    itemsContainer.appendChild(label);
                });

                const otherWrapper = document.createElement('div');
                const otherLabel = createCheckboxItem('其他（請自行輸入）', category.title, true, category.id, category.id, null);
                otherWrapper.appendChild(otherLabel);

                const otherInput = document.createElement('input');
                otherInput.type = 'text';
                otherInput.id = `other-input-${category.id}`;
                otherInput.className = 'other-input';
                otherInput.placeholder = '請輸入缺件說明...';
                otherInput.addEventListener('input', generateText);

                otherWrapper.appendChild(otherInput);
                itemsContainer.appendChild(otherWrapper);

                section.appendChild(itemsContainer);
                container.appendChild(section);
            });
        }

        function createCheckboxItem(text, categoryTitle, isOther, categoryId = null, groupId = null, itemId = null) {
            const label = document.createElement('label');
            label.className = 'checkbox-item';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.dataset.text = text;
            checkbox.dataset.category = categoryTitle;
            checkbox.dataset.groupId = groupId; 
            if (itemId) checkbox.dataset.itemId = itemId;
            
            if (isOther && categoryId) {
                checkbox.dataset.isOther = 'true';
                checkbox.dataset.categoryId = categoryId;
                checkbox.addEventListener('change', (e) => {
                    const inputField = document.getElementById(`other-input-${categoryId}`);
                    if (e.target.checked) {
                        inputField.classList.add('show');
                        inputField.focus();
                    } else {
                        inputField.classList.remove('show');
                        inputField.value = '';
                    }
                    generateText();
                });
            } else {
                checkbox.addEventListener('change', generateText);
            }

            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            
            label.appendChild(checkbox);
            label.appendChild(textSpan);
            
            return label;
        }

        function handleInput() {
            const input = document.getElementById('caseNumber');
            const errorMsg = document.getElementById('caseNumber-error');
            input.classList.remove('is-invalid');
            errorMsg.classList.remove('show');
            generateText();
        }

        function validateCaseNumber() {
            const input = document.getElementById('caseNumber');
            const errorMsg = document.getElementById('caseNumber-error');
            const val = input.value.trim().replace(/\s+/g, '');
            const len = val.length;

            if (len > 0 && len !== 14 && len !== 17) {
                input.classList.add('is-invalid');
                errorMsg.classList.add('show');
                generateText(); 
            } else {
                input.classList.remove('is-invalid');
                errorMsg.classList.remove('show');
                generateText();
            }
        }

        // ============================================
        // 統一的表單檢查函式 (防呆機制)
        // ============================================
        function validateForm() {
            let errors = [];
            
            const caseNumber = document.getElementById('caseNumber').value.trim();
            const applicantName = document.getElementById('applicantName').value.trim();
            const applicantEmail = document.getElementById('applicantEmail').value.trim();
            const checkedBoxes = document.querySelectorAll('input[type="checkbox"]:checked');
            
            // 檢查收件編號
            if (!caseNumber) {
                errors.push("● 收件編號：未填寫");
            } else if (document.getElementById('caseNumber').classList.contains('is-invalid')) {
                errors.push("● 收件編號：格式錯誤");
            }

            // 檢查姓名
            if (!applicantName) {
                errors.push("● 申請人姓名：未填寫");
            }

            // 檢查信箱
            if (!applicantEmail) {
                errors.push("● 申請人信箱：未填寫");
            }

            // 檢查勾選項目
            if (checkedBoxes.length === 0) {
                errors.push("● 缺件項目：未勾選（請至少勾選一項）");
            }

            return errors;
        }

        function generateText() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            const resultArea = document.getElementById('result-text');
            
            const caseNumberInput = document.getElementById('caseNumber');
            const caseNumber = caseNumberInput.value.trim();
            const applicantName = document.getElementById('applicantName').value.trim() || '申請人';
            const applicantEmail = document.getElementById('applicantEmail').value.trim();
            
            // 新增：取得申請類別資料
            const applicationType = document.getElementById('applicationType').value;

            let year = "○○";
            let month = "○○";
            let day = "○○";

            const cleanCaseNo = caseNumber.replace(/\s+/g, '');
            const len = cleanCaseNo.length;
            
            const hasError = caseNumberInput.classList.contains('is-invalid');

            if (hasError) {
                year = "(格式錯誤)"; month = "!"; day = "!";
            } else {
                if (len === 14) {
                    year = cleanCaseNo.substring(1, 4);
                    month = cleanCaseNo.substring(4, 6);
                    day = cleanCaseNo.substring(6, 8);
                } else if (len === 17) {
                    year = cleanCaseNo.substring(4, 7);
                    month = cleanCaseNo.substring(7, 9);
                    day = cleanCaseNo.substring(9, 11);
                }
            }

            globalEmail = applicantEmail;
            
            let subjectLine = `【補件通知】節能電器退還減徵貨物稅申請案`;
            if (caseNumber) {
                subjectLine += `（收件編號：${caseNumber}）`;
            }
            globalSubject = subjectLine;

            let fullText = "";
            if (applicantEmail) {
                fullText += `收件信箱：${applicantEmail}\n`;
            }
            fullText += `主旨：${subjectLine}\n\n`;
            
            let bodyContent = "";
            bodyContent += `${applicantName} 先生／小姐 您好：\n`;
            
            // 修改：將申請類別插入句子中
            bodyContent += `您於${year}年${month}月${day}日申請「購買節能電器(${applicationType})退還減徵貨物稅」一案`;
            
            const caseInfo = caseNumber ? `（收件編號：${caseNumber}）` : '';
            bodyContent += `${caseInfo}，經本機關審查，尚有部分申請資料未齊，請依下列事項補正相關文件：\n\n`;

            if (checkboxes.length === 0) {
                bodyContent += "（請在左側勾選缺件項目）\n";
            } else {
                let currentCategory = "";
                let categoryCounter = 0;
                
                checkboxes.forEach((cb) => {
                    const categoryTitle = cb.dataset.category;
                    const itemId = cb.dataset.itemId;
                    let itemText = cb.dataset.text;

                    if (['5-2', '5-3', '5-4'].includes(itemId)) {
                        itemText += '（高風險行業為房屋修繕、住宅營建、室內裝潢、房屋設備安裝、家電批發/零售等11類營業項目）';
                    }

                    if (cb.dataset.isOther === 'true') {
                        const categoryId = cb.dataset.categoryId;
                        const customInput = document.getElementById(`other-input-${categoryId}`);
                        itemText = (customInput && customInput.value.trim() !== '') 
                                   ? customInput.value.trim() 
                                   : '（請補正相關文件）';
                    }

                    if (categoryTitle !== currentCategory) {
                        categoryCounter++;
                        const numPrefix = CHINESE_NUMS[categoryCounter - 1] || categoryCounter;
                        bodyContent += `${numPrefix}、${categoryTitle}：\n`;
                        currentCategory = categoryTitle;
                    }
                    
                    bodyContent += `  ● ${itemText}\n`;
                });
            }

            bodyContent += `\n請於收到本通知後3日內完成補件。\n`;
            bodyContent += `如以電子郵件方式補件，請直接回覆本信件（Reply），並保留原信件主旨「${subjectLine}」，請勿自行修改。\n`;
            bodyContent += `未依上述方式回覆，可能影響本機關收件與案件辨識。\n`;
            bodyContent += `或可將補件資料傳真至${OFFICER_INFO.faxNumber}。\n`;
            bodyContent += `若有任何疑問，歡迎來電洽詢。\n\n`;
            bodyContent += `敬祝  順心\n`;
            bodyContent += `財政部高雄國稅局苓雅稽徵所  敬啟\n`;
            bodyContent += `\n--------------------------------\n`;
            bodyContent += `承辦單位：${OFFICER_INFO.unitName}\n`;
            bodyContent += `承辦人：${OFFICER_INFO.officerName}\n`;
            bodyContent += `電話：${OFFICER_INFO.officerPhone}\n`;
            bodyContent += `傳真：${OFFICER_INFO.faxNumber}\n`;
            bodyContent += `電子信箱：${OFFICER_INFO.email}`;

            globalBody = bodyContent;
            resultArea.value = fullText + bodyContent;
        }

        function copyToClipboard() {
            // 防呆檢核
            const errors = validateForm();
            if (errors.length > 0) {
                alert("⚠️【資料不完整，無法複製】\n\n請補齊下列資訊後再執行複製：\n\n" + errors.join("\n"));
                return;
            }

            const copyText = document.getElementById("result-text");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            document.execCommand("copy");
            showToast("已複製全部內容！");
        }

        function copySpecific(type) {
            // 防呆檢核
            const errors = validateForm();
            if (errors.length > 0) {
                alert("⚠️【資料不完整，無法複製】\n\n請補齊下列資訊後再執行複製：\n\n" + errors.join("\n"));
                return;
            }

            let textToCopy = "";
            let msg = "";

            if (type === 'email') {
                textToCopy = globalEmail;
                msg = "已複製信箱！";
                if (!textToCopy) msg = "無信箱資料";
            } else if (type === 'subject') {
                textToCopy = globalSubject;
                msg = "已複製主旨！";
            } else if (type === 'body') {
                textToCopy = globalBody;
                msg = "已複製內文！";
            }

            if (textToCopy) {
                const tempInput = document.createElement("textarea");
                tempInput.value = textToCopy;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand("copy");
                document.body.removeChild(tempInput);
                showToast(msg);
            } else {
                showToast(msg);
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-message');
            toastMsg.textContent = message;
            
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderChecklist();
            generateText();
        });
    </script>
</body>
</html>